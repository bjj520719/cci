# 定时任务<a name="cci_01_0066"></a>

任务负载是负责批量处理短暂的一次性任务\(short lived one-off tasks\)，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。

定时任务（CronJob）是基于时间控制的短时任务（Job），就类似于Linux系统的crontab，在指定的时间周期运行指定的短时任务。

## 创建定时任务<a name="section145271625910"></a>

1.  登录云容器实例管理控制台，左侧导航栏中选择“工作负载 \> 定时任务“，在右侧页面单击“创建定时任务“。
2.  添加基本信息。

    **表 1**  镜像参数说明

    <a name="table11384135810128"></a>
    <table><thead align="left"><tr id="row939410581127"><th class="cellrowborder" valign="top" width="23%" id="mcps1.2.3.1.1"><p id="p1939785831215"><a name="p1939785831215"></a><a name="p1939785831215"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="77%" id="mcps1.2.3.1.2"><p id="p1139825841219"><a name="p1139825841219"></a><a name="p1139825841219"></a>说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row114036586128"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p840605891219"><a name="p840605891219"></a><a name="p840605891219"></a>任务名称</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p04091658131212"><a name="p04091658131212"></a><a name="p04091658131212"></a>负载名称。</p>
    </td>
    </tr>
    <tr id="row11409135861216"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p1341219588127"><a name="p1341219588127"></a><a name="p1341219588127"></a>命名空间</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p94772059191319"><a name="p94772059191319"></a><a name="p94772059191319"></a>选择命名空间，如果还未创建命名空间，请参考<a href="命名空间.md">命名空间</a>创建。</p>
    </td>
    </tr>
    <tr id="row06555120226"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p666105116229"><a name="p666105116229"></a><a name="p666105116229"></a>任务描述</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p1092425210222"><a name="p1092425210222"></a><a name="p1092425210222"></a>描述信息，少于等于250个字符。</p>
    </td>
    </tr>
    <tr id="row4987203214413"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p11693858923"><a name="p11693858923"></a><a name="p11693858923"></a>并发策略</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p5242153012310"><a name="p5242153012310"></a><a name="p5242153012310"></a>支持三种并发策略</p>
    <a name="ul1331412428315"></a><a name="ul1331412428315"></a><ul id="ul1331412428315"><li>Forbid：在前一个任务未完成时，不创建新任务。</li><li>Allow：定时任务不断新建Job。</li><li>Replace：已到新任务创建时间点，但前一个任务还未完成，新的任务会取代前一个任务。</li></ul>
    </td>
    </tr>
    <tr id="row498733211443"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p7968632164415"><a name="p7968632164415"></a><a name="p7968632164415"></a>定时规则</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p797073216448"><a name="p797073216448"></a><a name="p797073216448"></a>指定新建定时任务在何时执行。</p>
    </td>
    </tr>
    <tr id="row1798753210447"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p16306324420"><a name="p16306324420"></a><a name="p16306324420"></a>任务记录</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p156385321411"><a name="p156385321411"></a><a name="p156385321411"></a>任务记录</p>
    </td>
    </tr>
    </tbody>
    </table>

3.  添加容器。
    1.  选择需要部署的镜像。
        -   我的镜像：展示了您上传到容器镜像服务的镜像。
        -   Docker官方镜像：展示了Dockerhub上的公共镜像。
        -   共享镜像：展示了容器镜像服务中他人共享的镜像。

    2.  配置镜像参数。

        **表 2**  镜像参数说明

        <a name="table128216444815"></a>
        <table><thead align="left"><tr id="row0282348486"><th class="cellrowborder" valign="top" width="23%" id="mcps1.2.3.1.1"><p id="p3282147483"><a name="p3282147483"></a><a name="p3282147483"></a>参数</p>
        </th>
        <th class="cellrowborder" valign="top" width="77%" id="mcps1.2.3.1.2"><p id="p1828244144819"><a name="p1828244144819"></a><a name="p1828244144819"></a>说明</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row48048642214"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p880613615224"><a name="p880613615224"></a><a name="p880613615224"></a>镜像版本</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p08061166224"><a name="p08061166224"></a><a name="p08061166224"></a>选择镜像的版本。</p>
        </td>
        </tr>
        <tr id="row32839494813"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p122831140486"><a name="p122831140486"></a><a name="p122831140486"></a>容器名称</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p528314415486"><a name="p528314415486"></a><a name="p528314415486"></a>容器的名称，可修改。</p>
        </td>
        </tr>
        <tr id="row152831345485"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p875325925918"><a name="p875325925918"></a><a name="p875325925918"></a>容器规格</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><a name="ul13282205619311"></a><a name="ul13282205619311"></a><ul id="ul13282205619311"><li>Pod的CPU取值范围为0.25核-32核，且单个容器的CPU必须为0.25核的整数倍</li><li>Pod的内存取值范围为1GB-128GB，且内存必须为1GB的整数倍</li><li>Pod的CPU/内存配比值必须在1:2到1:4之间</li><li>一个Pod内最多支持5个容器，单个容器最小配置是0.25核、0.2GB，最大同容器实例的最大配置</li></ul>
        </td>
        </tr>
        </tbody>
        </table>

    3.  （可选）高级设置。

        **表 3**  高级设置

        <a name="table133789295466"></a>
        <table><thead align="left"><tr id="row13821229204611"><th class="cellrowborder" valign="top" width="23%" id="mcps1.2.3.1.1"><p id="p16383192911468"><a name="p16383192911468"></a><a name="p16383192911468"></a>参数</p>
        </th>
        <th class="cellrowborder" valign="top" width="77%" id="mcps1.2.3.1.2"><p id="p133851829144616"><a name="p133851829144616"></a><a name="p133851829144616"></a>说明</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row11395929134618"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p1396192914613"><a name="p1396192914613"></a><a name="p1396192914613"></a>日志采集</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p839812911462"><a name="p839812911462"></a><a name="p839812911462"></a>支持根据您配置的日志输出路径，采集负载日志，并进行防爆处理。</p>
        <a name="ol9398142954614"></a><a name="ol9398142954614"></a><ol id="ol9398142954614"><li>单击添加日志存储。</li><li>输入容器内日志路径，调整日志存储空间。</li></ol>
        <p id="p15401429174616"><a name="p15401429174616"></a><a name="p15401429174616"></a>负载创建完成后，可在AOM界面查看日志，具体请参见<a href="日志管理.md">日志管理</a>。</p>
        </td>
        </tr>
        <tr id="row34013296467"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p12403829134614"><a name="p12403829134614"></a><a name="p12403829134614"></a>环境变<span>量</span></p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p15405162911462"><a name="p15405162911462"></a><a name="p15405162911462"></a><span>容器运行环境中设定的一个变量。可以在负载部署后修改，为负载提供极大的灵活性。</span></p>
        <a name="ul440792916462"></a><a name="ul440792916462"></a><ul id="ul440792916462"><li>手动输入<a name="ol18409172964610"></a><a name="ol18409172964610"></a><ol id="ol18409172964610"><li>单击<span class="uicontrol" id="uicontrol104101629124614"><a name="uicontrol104101629124614"></a><a name="uicontrol104101629124614"></a>“添加变量”</span>。</li><li>输入变量名称、变量值。</li></ol>
        </li><li>变量引用<a name="ol14414122910464"></a><a name="ol14414122910464"></a><ol id="ol14414122910464"><li>单击添加引用。</li><li>输入变量名称，选择引用类型、引用值。其中Secret引用的创建请参见<a href="使用Secret.md">使用Secret</a>。</li></ol>
        </li></ul>
        </td>
        </tr>
        <tr id="row154171129154615"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p11419029144614"><a name="p11419029144614"></a><a name="p11419029144614"></a>存活探针</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p6420102914469"><a name="p6420102914469"></a><a name="p6420102914469"></a>用于容器的自定义监控检查，如果检查失败，云容器实例将删除该应用实例，然后根据默认重启策略来决定是否重启容器。详细步骤请参见<a href="容器健康检查.md">容器健康检查</a>。</p>
        </td>
        </tr>
        <tr id="row4421129154612"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p1422102910469"><a name="p1422102910469"></a><a name="p1422102910469"></a>生命周<span>期</span></p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><div class="p" id="p184231329144612"><a name="p184231329144612"></a><a name="p184231329144612"></a><span>生命周期脚本定义，主要针对容器类负载的生命周期事件负载采取的动作。</span>详细步骤请参见<a href="容器生命周期.md">容器生命周期</a>。<a name="ul1242514292461"></a><a name="ul1242514292461"></a><ul id="ul1242514292461"><li>启动后处<span>理：容器启动后触发。</span></li><li>停止前处理：容器停止前触发。</li></ul>
        </div>
        </td>
        </tr>
        <tr id="row17427182944616"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p9428172924619"><a name="p9428172924619"></a><a name="p9428172924619"></a>启动命令</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p1643022984611"><a name="p1643022984611"></a><a name="p1643022984611"></a>输入容器启动命令，容器启动后会立即执行。</p>
        <p id="p0430142924614"><a name="p0430142924614"></a><a name="p0430142924614"></a>启动命令对应于docker的ENTRYPOINT启动命令，详细内容请参见<a href="容器启动命令.md">容器启动命令</a>。</p>
        </td>
        </tr>
        <tr id="row74341429124613"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p10436172912465"><a name="p10436172912465"></a><a name="p10436172912465"></a>配置管理</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p10437229174612"><a name="p10437229174612"></a><a name="p10437229174612"></a>容器支持挂载ConfigMap和Secret。</p>
        <p id="p174373297469"><a name="p174373297469"></a><a name="p174373297469"></a>ConfigMap和Secret的创建请参见<a href="使用ConfigMap.md">使用ConfigMap</a>和<a href="使用Secret.md">使用Secret</a>。</p>
        </td>
        </tr>
        </tbody>
        </table>

    4.  （可选）一个任务实例包含1个或多个相关容器。若您的任务包含多个容器，请单击“添加容器“，再执行添加容器的操作。

        >![](public_sys-resources/icon-notice.gif) **注意：**   
        >同一个Pod实例中的不同容器如果监听了相同的端口，则会导致端口冲突，Pod可能会启动失败。例如在Pod中添加了一个nginx镜像容器，启动了80端口，如果该Pod中另一个http服务的镜像也启动80端口，那么这个Pod就会出现端口冲突。  


4.  单击“下一步“，单击“提交”，单击“任务列表”。

    在任务列表中，待任务状态为“运行中“，任务创建成功。您可以单击负载名进入任务详情界面，按F5查看任务实时状态。


