# 任务负载管理<a name="cci_01_0051"></a>

任务负载是负责批量处理短暂的一次性任务\(short lived one-off tasks\)，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。

-   短时任务（Job）：是Kubernetes用来控制批处理型任务的资源对象。批处理业务与长期伺服业务（Deployment）的主要区别是批处理业务的运行有头有尾，而长期伺服业务在用户不停止的情况下永远运行。Job管理的Pod根据用户的设置把任务成功完成就自动退出（Pod自动删除）。
-   定时任务（CronJob）：是基于时间的Job，就类似于Linux系统的crontab，在指定的时间周期运行指定的Job。

任务负载的这种用完即停止的特性特别适合一次性任务，比如持续集成，配合云容器实例按秒计费，真正意义上做到按需使用。

## 创建短时任务<a name="section1754218181551"></a>

1.  登录云容器实例管理控制台，左侧导航栏中选择“任务负载\>短时任务“，在右侧页面中选择命名空间，单击“创建短时任务“。
2.  添加容器。
    1.  选择需要部署的镜像。
        -   我的镜像：展示了您上传到容器镜像服务的镜像。
        -   Docker官方镜像：展示了Dockerhub上的公共镜像。

    2.  配置镜像参数。

        **表 1**  镜像参数说明

        <a name="table128216444815"></a>
        <table><thead align="left"><tr id="row0282348486"><th class="cellrowborder" valign="top" width="23%" id="mcps1.2.3.1.1"><p id="p3282147483"><a name="p3282147483"></a><a name="p3282147483"></a>参数</p>
        </th>
        <th class="cellrowborder" valign="top" width="77%" id="mcps1.2.3.1.2"><p id="p1828244144819"><a name="p1828244144819"></a><a name="p1828244144819"></a>说明</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row48048642214"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p880613615224"><a name="p880613615224"></a><a name="p880613615224"></a>镜像版本</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p08061166224"><a name="p08061166224"></a><a name="p08061166224"></a>选择镜像的版本。</p>
        </td>
        </tr>
        <tr id="row32839494813"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p122831140486"><a name="p122831140486"></a><a name="p122831140486"></a>容器名称</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p528314415486"><a name="p528314415486"></a><a name="p528314415486"></a>容器的名称，可修改。</p>
        </td>
        </tr>
        <tr id="row152831345485"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p875325925918"><a name="p875325925918"></a><a name="p875325925918"></a>容器规格</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><a name="ul13282205619311"></a><a name="ul13282205619311"></a><ul id="ul13282205619311"><li>Pod的CPU取值范围为0.25核-32核，且CPU必须为0.25核的整数倍</li><li>Pod的内存取值范围为1GB-128GB，且内存必须为1GB的整数倍</li><li>Pod的CPU/内存配比值必须在1:2到1:4之间</li><li>一个Pod内最多支持5个容器，单个容器最小配置是0.25核、0.2GB，最大同容器实例的最大配置。</li></ul>
        </td>
        </tr>
        </tbody>
        </table>

    3.  （可选）高级设置。

        **表 2**  高级设置

        <a name="table17053356320"></a>
        <table><thead align="left"><tr id="row167061935153213"><th class="cellrowborder" valign="top" width="23%" id="mcps1.2.3.1.1"><p id="p1370619354321"><a name="p1370619354321"></a><a name="p1370619354321"></a>参数</p>
        </th>
        <th class="cellrowborder" valign="top" width="77%" id="mcps1.2.3.1.2"><p id="p14706113513212"><a name="p14706113513212"></a><a name="p14706113513212"></a>说明</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row1326611285014"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p15172028154119"><a name="p15172028154119"></a><a name="p15172028154119"></a>存储</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p1652162817414"><a name="p1652162817414"></a><a name="p1652162817414"></a>支持挂载持久化卷到容器中，以实现数据文件的持久化存储。当前支持云硬盘卷和文件存储卷。</p>
        <a name="ol7523142816416"></a><a name="ol7523142816416"></a><ol id="ol7523142816416"><li>单击<span class="uicontrol" id="uicontrol195306282416"><a name="uicontrol195306282416"></a><a name="uicontrol195306282416"></a>“添加云硬盘卷”</span>或<span class="uicontrol" id="uicontrol1460518184113"><a name="uicontrol1460518184113"></a><a name="uicontrol1460518184113"></a>“添加文件存储卷”</span>。</li><li>输入名称、容量、容器内挂载路径，选择磁盘类型。</li></ol>
        <p id="p125360285419"><a name="p125360285419"></a><a name="p125360285419"></a>负载创建完成后，可对存储卷进行管理，具体请参见<a href="云硬盘卷.md">云硬盘卷</a>或<a href="文件存储卷.md">文件存储卷</a>。</p>
        </td>
        </tr>
        <tr id="row1070314175020"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p8670718111715"><a name="p8670718111715"></a><a name="p8670718111715"></a>日志采集</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p167031813177"><a name="p167031813177"></a><a name="p167031813177"></a>支持根据您配置的日志输出路径，采集负载日志，并按老化周期（当前固定为1小时）进行防爆处理。</p>
        <a name="ol1888210123245"></a><a name="ol1888210123245"></a><ol id="ol1888210123245"><li>单击添加日志存储。</li><li>输入容器内日志路径，调整日志存储空间。</li></ol>
        <p id="p9370433182511"><a name="p9370433182511"></a><a name="p9370433182511"></a>负载创建完成后，可在AOM界面查看日志，具体请参见<a href="日志管理.md">日志管理</a>。</p>
        </td>
        </tr>
        <tr id="row10165174402214"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p670763593219"><a name="p670763593219"></a><a name="p670763593219"></a>环境变<span>量</span></p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p195601892108"><a name="p195601892108"></a><a name="p195601892108"></a><span>容器运行环境中设定的一个变量。可以在负载部署后修改，为负载提供极大的灵活性。</span></p>
        <a name="ul789917269235"></a><a name="ul789917269235"></a><ul id="ul789917269235"><li>手动输入<a name="ol132614379232"></a><a name="ol132614379232"></a><ol id="ol132614379232"><li>单击<span class="uicontrol" id="uicontrol1412691510249"><a name="uicontrol1412691510249"></a><a name="uicontrol1412691510249"></a>“添加变量”</span>。</li><li>输入变量名称、变量值。</li></ol>
        </li><li>变量引用<a name="ol1160515682420"></a><a name="ol1160515682420"></a><ol id="ol1160515682420"><li>单击添加引用。</li><li>输入变量名称，选择引用类型、引用值。其中Secret引用的创建请参见<a href="使用Secret.md">使用Secret</a>。</li></ol>
        </li></ul>
        </td>
        </tr>
        <tr id="row173162112241"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p4932225132415"><a name="p4932225132415"></a><a name="p4932225132415"></a>存活探针</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p199349253240"><a name="p199349253240"></a><a name="p199349253240"></a>用于容器的自定义监控检查，如果检查失败，云容器实例将删除该应用实例，然后根据默认重启策略来决定是否重启容器。详细步骤请参见<a href="设置容器健康检查.md">设置容器健康检查</a>。</p>
        </td>
        </tr>
        <tr id="row17061435113218"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p157061235123216"><a name="p157061235123216"></a><a name="p157061235123216"></a>生命周<span>期</span></p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><div class="p" id="p15201232375"><a name="p15201232375"></a><a name="p15201232375"></a><span>生命周期脚本定义，主要针对容器类负载的生命周期事件负载采取的动作。</span>详细步骤请参见<a href="设置容器生命周期.md">设置容器生命周期</a>。<a name="ul7468112919334"></a><a name="ul7468112919334"></a><ul id="ul7468112919334"><li>启动后处<span>理：容器启动后触发。</span></li><li>停止前处理：容器停止前触发。</li></ul>
        </div>
        </td>
        </tr>
        <tr id="row725218519814"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p0252155183"><a name="p0252155183"></a><a name="p0252155183"></a>启动命令</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p1660418369565"><a name="p1660418369565"></a><a name="p1660418369565"></a>输入容器启动命令，容器启动后会立即执行。</p>
        <p id="p14252651281"><a name="p14252651281"></a><a name="p14252651281"></a>启动命令对应于docker的ENTRYPOINT启动命令，详细内容请参见<a href="容器启动命令.md">容器启动命令</a>。</p>
        </td>
        </tr>
        <tr id="row12584143142315"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p10585174311234"><a name="p10585174311234"></a><a name="p10585174311234"></a>ConfigMap</p>
        </td>
        <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p3585443172313"><a name="p3585443172313"></a><a name="p3585443172313"></a>指容器在运行过程中可使用的配置项（ConfigMap）。</p>
        <p id="p1987986123617"><a name="p1987986123617"></a><a name="p1987986123617"></a>单击<span class="uicontrol" id="uicontrol0855185493517"><a name="uicontrol0855185493517"></a><a name="uicontrol0855185493517"></a>“添加ConfigMap”</span>，选择已有配置项。配置项的创建请参见<a href="使用ConfigMap.md">使用ConfigMap</a>。</p>
        </td>
        </tr>
        </tbody>
        </table>

    4.  （可选）一个任务实例包含1个或多个相关容器。若您的任务包含多个容器，请单击“添加容器“，再执行添加容器的操作。

        >![](public_sys-resources/icon-notice.gif) **注意：**   
        >同一个Pod实例中的不同容器如果监听了相同的端口，则会导致端口冲突，Pod可能会启动失败。例如在Pod中添加了一个nginx镜像容器，启动了80端口，如果该Pod中另一个http服务的镜像也启动80端口，那么这个Pod就会出现端口冲突。  


3.  单击“下一步“，根据需要配置Pod数量和域名。

    **表 3**  负载信息

    <a name="table1827691822212"></a>
    <table><thead align="left"><tr id="row4285171810225"><th class="cellrowborder" valign="top" width="23%" id="mcps1.2.3.1.1"><p id="p3287201802216"><a name="p3287201802216"></a><a name="p3287201802216"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="77%" id="mcps1.2.3.1.2"><p id="p9290201818226"><a name="p9290201818226"></a><a name="p9290201818226"></a>说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row32921418122219"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p47541252112217"><a name="p47541252112217"></a><a name="p47541252112217"></a>任务名称</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p6295718162217"><a name="p6295718162217"></a><a name="p6295718162217"></a>负载名称，请输入以小写字母或数字开头，小写字母、数字、中划线（-）、点（.）组成（其中两点不能相连，点不能与中划线相连），小写字母或数字结尾的1到63字符的字符串。</p>
    </td>
    </tr>
    <tr id="row202961188223"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p20956105910229"><a name="p20956105910229"></a><a name="p20956105910229"></a>任务描述</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p2959172813235"><a name="p2959172813235"></a><a name="p2959172813235"></a>描述信息，少于等于250个字符。</p>
    </td>
    </tr>
    <tr id="row530721816224"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p18309101852219"><a name="p18309101852219"></a><a name="p18309101852219"></a>任务类型</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><a name="ul1948183010246"></a><a name="ul1948183010246"></a><ul id="ul1948183010246"><li>一次性任务：一次性任务每次创建一个Pod，直至一个Pod成功执行，任务完成。</li><li>自定义任务：自定义任务的执行次数和每次并行执行的数量。</li></ul>
    </td>
    </tr>
    <tr id="row15721163462113"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p11721534132115"><a name="p11721534132115"></a><a name="p11721534132115"></a>执行次数（自定义任务需要配置）</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p6721193472112"><a name="p6721193472112"></a><a name="p6721193472112"></a>执行次数指任务负载达到执行完成状态需要成功执行的Pod数量。</p>
    </td>
    </tr>
    <tr id="row132052056132111"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p1420545672120"><a name="p1420545672120"></a><a name="p1420545672120"></a>并行数（自定义任务需要配置）</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p19205456182117"><a name="p19205456182117"></a><a name="p19205456182117"></a>并行数指任务负载执行过程中允许同时创建的最大Pod数，并行数应小于执行次数。</p>
    </td>
    </tr>
    <tr id="row18993115362610"><td class="cellrowborder" valign="top" width="23%" headers="mcps1.2.3.1.1 "><p id="p175039411224"><a name="p175039411224"></a><a name="p175039411224"></a>超时时间</p>
    </td>
    <td class="cellrowborder" valign="top" width="77%" headers="mcps1.2.3.1.2 "><p id="p392645220209"><a name="p392645220209"></a><a name="p392645220209"></a>当任务执行超出该时间时，任务会被标识为失败，任务负载下的所有Pod实例都会被删除。</p>
    <p id="p4237102715263"><a name="p4237102715263"></a><a name="p4237102715263"></a>为空时表示不设置。</p>
    </td>
    </tr>
    </tbody>
    </table>

4.  单击“下一步“，单击“启动任务”，单击“任务列表”。

    在任务列表中，待任务状态为“运行中“，任务创建成功。您可以单击负载名进入任务详情界面，按F5查看任务实时状态。


